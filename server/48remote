#!/bin/bash
# set -x

assets="assets/"

import=$assets"00-import"
printbox=$assets"01-printbox"
archives=$assets"02-archives"
replay=$assets"03-replay"

texlinks="tex_template/links"

bgColor="#4792ef"
bgFuzz=8

function importLast (){
  dir=$1
  rotate=0
  
  for pic in `find $dir -iname "*.jpg" -type f -print -quit`
  do    
  
    model=$(identify -format %[exif:Model] $pic)
    echo "* new picture from $model: $pic*"
    
    dirsource=$(basename $(dirname $pic))
    
    if [[ "$model" == *EOS* ]] 
    then
      convert $pic \
      -format png -auto-orient -rotate 90 \
      -fuzz $bgFuzz% -transparent $bgColor \
      -modulate 100,0 \
    	$texlinks"/$dirsource.png"
      
    elif [[ "$model" == *I9100* ]]
    then 
      convert $pic \
      -format jpeg -modulate 100,0 -auto-orient \
      $texlinks"/$dirsource.jpeg"
    fi
    
    mv $pic $archives"/$(basename $(dirname $pic))/$(basename $pic)"
  done 
}
function compilePDF (){
  now=$(date +"%y.%m.%d-%H.%M.%S")
  
  pdflatex tex_template/template_float_img.tex >/dev/null
  convert -format jpg -resize 1280x720 template_float_img.pdf "$replay/$now.jpg"
  mv -v template_float_img.pdf "$printbox/$now.pdf"
}
function print {
  
  inbox=$1
  outbox=$2
  
  printer=C224e_Labos                    # labos

  detox -vr $inbox
  
  for step in `find $inbox -iname "*.pdf" -type f`
  do
    stepname=$(basename $step)
    archivePath=$outbox$stepname
    
    mv -v $step $archivePath # copy in outbox (archives)
    lpr -P $printer -o media=A3 -o ColorModel=KGray -o fit-to-page $archivePath
    
  done
}

interval=${1-16}

while true; do
  
  importLast $import/phone
  importLast $import/table
  
  compilePDF
  print $printbox $archives"/printedpdf/"
  
  for (( i=$interval; i>0; i--)); do
    sleep 1 &
    printf "next print in $i s \r"
    wait    
    printf "                   \r"
  done
done